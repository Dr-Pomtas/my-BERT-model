<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Direct Test - User Experience</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
        button { margin: 10px; padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .step { margin: 20px 0; padding: 20px; border: 2px solid #ddd; border-radius: 10px; }
        .result { margin: 15px 0; padding: 15px; border-radius: 5px; }
        .error { background: #ffebee; color: #c62828; border: 1px solid #ef9a9a; }
        .success { background: #e8f5e8; color: #2e7d32; border: 1px solid #81c784; }
        .info { background: #e3f2fd; color: #1565c0; border: 1px solid #64b5f6; }
        .chart-container { margin: 20px 0; padding: 20px; border: 2px dashed #ddd; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background: #f5f5f5; }
    </style>
</head>
<body>
    <h1>ç›´æ¥ãƒ†ã‚¹ãƒˆ - ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</h1>
    <p>ã“ã®é¡µé¢ã§ã¯ã€å®Ÿéš›ã®åˆ†æãƒ•ãƒ­ãƒ¼ã‚’æ¨¡å€£ã—ã¦ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚</p>

    <div class="step">
        <h2>ã‚¹ãƒ†ãƒƒãƒ— 1: ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿</h2>
        <button id="step1Btn">ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨</button>
        <div id="step1Result" class="result"></div>
    </div>

    <div class="step">
        <h2>ã‚¹ãƒ†ãƒƒãƒ— 2: æ„Ÿæƒ…åˆ†æå®Ÿè¡Œ</h2>
        <button id="step2Btn" disabled>åˆ†æå®Ÿè¡Œ</button>
        <div id="step2Result" class="result"></div>
    </div>

    <div class="step">
        <h2>ã‚¹ãƒ†ãƒƒãƒ— 3: ãƒãƒ£ãƒ¼ãƒˆè¡¨ç¤ºç¢ºèª</h2>
        <button id="step3Btn" disabled>ãƒãƒ£ãƒ¼ãƒˆè¡¨ç¤ºãƒ†ã‚¹ãƒˆ</button>
        <div id="step3Result" class="result"></div>
        
        <div class="chart-container">
            <h3>æ˜Ÿè©•ä¾¡å††ã‚°ãƒ©ãƒ• (Canvas)</h3>
            <div id="starChart"></div>
        </div>
        
        <div class="chart-container">
            <h3>ãƒ¢ãƒ‡ãƒ«æ€§èƒ½æ¯”è¼ƒè¡¨</h3>
            <div id="modelTable"></div>
        </div>
        
        <div class="chart-container">
            <h3>ç—…é™¢åˆ¥åˆ†æ</h3>
            <div id="hospitalTable"></div>
        </div>
    </div>

    <div class="step">
        <h2>ã‚¹ãƒ†ãƒƒãƒ— 4: CSV ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</h2>
        <button id="step4Btn" disabled>CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
        <div id="step4Result" class="result"></div>
    </div>

    <script>
        let uploadedData = null;
        let analysisResults = null;

        // ã‚¹ãƒ†ãƒƒãƒ— 1: ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        document.getElementById('step1Btn').addEventListener('click', function() {
            const btn = this;
            const result = document.getElementById('step1Result');
            
            btn.disabled = true;
            result.innerHTML = '<div class="info">ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>';
            
            fetch('/load_sample_data')
                .then(response => response.json())
                .then(data => {
                    console.log('Step 1 - Sample data response:', data);
                    
                    if (data.success) {
                        uploadedData = data.data;
                        result.innerHTML = `
                            <div class="success">
                                âœ… ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿æˆåŠŸ<br>
                                - ãƒ¬ãƒ“ãƒ¥ãƒ¼æ•°: ${uploadedData.length}ä»¶<br>
                                - ç—…é™¢æ•°: ${data.stats.unique_hospitals}ä»¶<br>
                                - å¹³å‡æ˜Ÿè©•ä¾¡: ${data.stats.avg_star_rating.toFixed(2)}ç‚¹
                            </div>
                        `;
                        document.getElementById('step2Btn').disabled = false;
                    } else {
                        result.innerHTML = `<div class="error">âŒ ã‚¨ãƒ©ãƒ¼: ${data.error}</div>`;
                    }
                })
                .catch(error => {
                    console.error('Step 1 error:', error);
                    result.innerHTML = `<div class="error">âŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
                })
                .finally(() => {
                    btn.disabled = false;
                });
        });

        // ã‚¹ãƒ†ãƒƒãƒ— 2: åˆ†æå®Ÿè¡Œ
        document.getElementById('step2Btn').addEventListener('click', function() {
            const btn = this;
            const result = document.getElementById('step2Result');
            
            btn.disabled = true;
            result.innerHTML = '<div class="info">æ„Ÿæƒ…åˆ†æã‚’å®Ÿè¡Œä¸­... (æ•°ç§’ã‹ã‹ã‚Šã¾ã™)</div>';
            
            fetch('/analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ data: uploadedData })
            })
            .then(response => response.json())
            .then(data => {
                console.log('Step 2 - Analysis response:', data);
                
                if (data.success) {
                    analysisResults = data.results;
                    result.innerHTML = `
                        <div class="success">
                            âœ… åˆ†æå®Ÿè¡ŒæˆåŠŸ<br>
                            - åŸºæœ¬çµ±è¨ˆ: ${analysisResults.basic_stats ? 'âœ“' : 'âœ—'}<br>
                            - ãƒ¢ãƒ‡ãƒ«æ¯”è¼ƒ: ${analysisResults.model_comparison ? 'âœ“' : 'âœ—'}<br>
                            - æ˜Ÿè©•ä¾¡åˆ†å¸ƒ: ${analysisResults.star_rating_distribution ? 'âœ“' : 'âœ—'}<br>
                            - ç—…é™¢åˆ¥åˆ†æ: ${analysisResults.hospital_analysis ? 'âœ“' : 'âœ—'}
                        </div>
                    `;
                    document.getElementById('step3Btn').disabled = false;
                    document.getElementById('step4Btn').disabled = false;
                } else {
                    result.innerHTML = `<div class="error">âŒ åˆ†æã‚¨ãƒ©ãƒ¼: ${data.error}</div>`;
                }
            })
            .catch(error => {
                console.error('Step 2 error:', error);
                result.innerHTML = `<div class="error">âŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
            })
            .finally(() => {
                btn.disabled = false;
            });
        });

        // ã‚¹ãƒ†ãƒƒãƒ— 3: ãƒãƒ£ãƒ¼ãƒˆè¡¨ç¤º
        document.getElementById('step3Btn').addEventListener('click', function() {
            const result = document.getElementById('step3Result');
            
            if (!analysisResults) {
                result.innerHTML = '<div class="error">âŒ åˆ†æçµæœãŒã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }

            try {
                result.innerHTML = '<div class="info">ãƒãƒ£ãƒ¼ãƒˆã‚’ç”Ÿæˆä¸­...</div>';

                // 1. æ˜Ÿè©•ä¾¡å††ã‚°ãƒ©ãƒ•
                if (analysisResults.star_rating_distribution) {
                    createStarChart(analysisResults.star_rating_distribution);
                    result.innerHTML = '<div class="success">âœ… æ˜Ÿè©•ä¾¡å††ã‚°ãƒ©ãƒ•ä½œæˆå®Œäº†</div>';
                }

                // 2. ãƒ¢ãƒ‡ãƒ«æ€§èƒ½æ¯”è¼ƒè¡¨  
                if (analysisResults.model_comparison) {
                    createModelTable(analysisResults.model_comparison);
                    result.innerHTML += '<div class="success">âœ… ãƒ¢ãƒ‡ãƒ«æ€§èƒ½æ¯”è¼ƒè¡¨ä½œæˆå®Œäº†</div>';
                }

                // 3. ç—…é™¢åˆ¥åˆ†æè¡¨
                if (analysisResults.hospital_analysis) {
                    createHospitalTable(analysisResults.hospital_analysis);
                    result.innerHTML += '<div class="success">âœ… ç—…é™¢åˆ¥åˆ†æè¡¨ä½œæˆå®Œäº†</div>';
                }

            } catch (error) {
                console.error('Chart creation error:', error);
                result.innerHTML = `<div class="error">âŒ ãƒãƒ£ãƒ¼ãƒˆç”Ÿæˆã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
            }
        });

        // ã‚¹ãƒ†ãƒƒãƒ— 4: CSV ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        document.getElementById('step4Btn').addEventListener('click', function() {
            const result = document.getElementById('step4Result');
            
            result.innerHTML = '<div class="info">CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’æº–å‚™ä¸­...</div>';
            
            fetch('/export_results', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({})
            })
            .then(response => {
                if (response.ok) {
                    return response.blob();
                } else {
                    return response.json().then(data => {
                        throw new Error(data.error || `HTTP ${response.status}`);
                    });
                }
            })
            .then(blob => {
                // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Ÿè¡Œ
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `analysis_${new Date().toISOString().slice(0,10)}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                result.innerHTML = '<div class="success">âœ… CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæˆåŠŸ</div>';
            })
            .catch(error => {
                console.error('Export error:', error);
                result.innerHTML = `<div class="error">âŒ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
            });
        });

        // ãƒãƒ£ãƒ¼ãƒˆä½œæˆé–¢æ•°
        function createStarChart(starData) {
            const container = document.getElementById('starChart');
            container.innerHTML = '';
            
            const canvas = document.createElement('canvas');
            canvas.width = 300;
            canvas.height = 300;
            canvas.style.border = '1px solid #ddd';
            container.appendChild(canvas);
            
            const ctx = canvas.getContext('2d');
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = Math.min(centerX, centerY) - 40;
            
            const colors = ['#dc3545', '#fd7e14', '#ffc107', '#198754', '#20c997'];
            const total = Object.values(starData).reduce((sum, count) => sum + count, 0);
            
            let currentAngle = -Math.PI / 2;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            ['1', '2', '3', '4', '5'].forEach((rating, index) => {
                const count = starData[rating] || 0;
                const angle = total > 0 ? (count / total) * 2 * Math.PI : 0;
                
                if (angle > 0) {
                    ctx.beginPath();
                    ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + angle);
                    ctx.lineTo(centerX, centerY);
                    ctx.fillStyle = colors[index];
                    ctx.fill();
                    ctx.strokeStyle = '#fff';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                    currentAngle += angle;
                }
            });
            
            ctx.fillStyle = '#333';
            ctx.font = 'bold 16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('æ˜Ÿè©•ä¾¡åˆ†å¸ƒ', centerX, 25);
        }

        function createModelTable(modelData) {
            const container = document.getElementById('modelTable');
            const models = Object.keys(modelData);
            const sortedModels = models.sort((a, b) => (modelData[a].mae || 0) - (modelData[b].mae || 0));
            
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>ãƒ©ãƒ³ã‚¯</th>
                            <th>ãƒ¢ãƒ‡ãƒ«å</th>
                            <th>MAE</th>
                            <th>ç›¸é–¢ä¿‚æ•°</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            sortedModels.forEach((model, index) => {
                const mae = modelData[model].mae || 0;
                const correlation = modelData[model].correlation || 0;
                const rank = index + 1;
                const rankIcon = rank === 1 ? 'ğŸ¥‡' : rank === 2 ? 'ğŸ¥ˆ' : 'ğŸ¥‰';
                
                html += `
                    <tr>
                        <td>${rankIcon} ${rank}ä½</td>
                        <td><strong>${model}</strong></td>
                        <td>${mae.toFixed(4)}</td>
                        <td>${correlation.toFixed(3)}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function createHospitalTable(hospitalData) {
            const container = document.getElementById('hospitalTable');
            const hospitalIds = Object.keys(hospitalData).slice(0, 5); // æœ€åˆã®5ç—…é™¢ã®ã¿è¡¨ç¤º
            
            let html = `
                <p><strong>ç—…é™¢åˆ¥åˆ†æ (æœ€åˆã®5ç—…é™¢)</strong></p>
                <table>
                    <thead>
                        <tr>
                            <th>ç—…é™¢ID</th>
                            <th>ãƒ¬ãƒ“ãƒ¥ãƒ¼æ•°</th>
                            <th>å¹³å‡æ˜Ÿè©•ä¾¡</th>
                            <th>Koheiduck</th>
                            <th>LLM-book</th>
                            <th>Mizuiro</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            hospitalIds.forEach(hospitalId => {
                const data = hospitalData[hospitalId];
                console.log(`Hospital ${hospitalId} data:`, data);
                
                // ãƒ¢ãƒ‡ãƒ«ã‚¹ã‚³ã‚¢ã‚’å®‰å…¨ã«å–å¾—
                const koheiduck = data['Model A (Koheiduck)_score'] || data.koheiduck_score || 0;
                const llmbook = data['Model B (LLM-book)_score'] || data.llmbook_score || 0;
                const mizuiro = data['Model C (Mizuiro)_score'] || data.mizuiro_score || 0;
                
                html += `
                    <tr>
                        <td><strong>${hospitalId}</strong></td>
                        <td>${data.review_count || 0}ä»¶</td>
                        <td>${(data.avg_star_rating || data.avg_rating || 0).toFixed(2)}ç‚¹</td>
                        <td>${koheiduck.toFixed(3)}</td>
                        <td>${llmbook.toFixed(3)}</td>
                        <td>${mizuiro.toFixed(3)}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
    </script>
</body>
</html>