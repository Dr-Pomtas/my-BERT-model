<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‹•ç‰©ç—…é™¢å£ã‚³ãƒŸåˆ†æã‚·ã‚¹ãƒ†ãƒ </title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container-fluid">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <header class="bg-primary text-white p-4 mb-4">
            <h1 class="h2 mb-0"><i class="fas fa-chart-line me-2"></i>å‹•ç‰©ç—…é™¢å£ã‚³ãƒŸåˆ†æã‚·ã‚¹ãƒ†ãƒ </h1>
            <p class="mb-0 mt-2">Japanese BERT Models Performance Analysis for Veterinary Hospital Reviews</p>
        </header>

        <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <div class="row">
            <div class="col-12">
                <!-- Step 1: ãƒ‡ãƒ¼ã‚¿ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ -->
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h3 class="card-title mb-0"><i class="fas fa-upload me-2"></i>Step 1: ãƒ‡ãƒ¼ã‚¿ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="upload-area border rounded p-4 text-center" id="uploadArea">
                                    <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                                    <h5>CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h5>
                                    <p class="text-muted">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã™ã‚‹ã‹ã€ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠã—ã¦ãã ã•ã„</p>
                                    <input type="file" id="fileInput" accept=".csv" class="d-none">
                                    <button class="btn btn-outline-primary me-2" onclick="document.getElementById('fileInput').click()">
                                        <i class="fas fa-folder-open me-1"></i>ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
                                    </button>
                                    <button class="btn btn-outline-success" id="loadSampleBtn">
                                        <i class="fas fa-download me-1"></i>ã‚µãƒ³ãƒ—ãƒ«ä½¿ç”¨
                                    </button>
                                </div>
                                <div class="mt-3">
                                    <div class="alert alert-info mb-0">
                                        <small><strong>å¿…è¦ãªåˆ—:</strong> hospital_id, review_text, star_rating (1-5)</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div id="dataStats" class="d-none">
                                    <h5><i class="fas fa-info-circle me-2"></i>ãƒ‡ãƒ¼ã‚¿æ¦‚è¦</h5>
                                    <div class="row">
                                        <div class="col-6">
                                            <div class="stat-card">
                                                <div class="stat-value" id="totalReviews">-</div>
                                                <div class="stat-label">ç·å£ã‚³ãƒŸæ•°</div>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="stat-card">
                                                <div class="stat-value" id="uniqueHospitals">-</div>
                                                <div class="stat-label">ç—…é™¢æ•°</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row mt-2">
                                        <div class="col-12">
                                            <div class="stat-card">
                                                <div class="stat-value" id="avgStarRating">-</div>
                                                <div class="stat-label">å¹³å‡æ˜Ÿè©•ä¾¡</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 2: æ„Ÿæƒ…åˆ†æå®Ÿè¡Œ -->
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h3 class="card-title mb-0"><i class="fas fa-brain me-2"></i>Step 2: æ„Ÿæƒ…åˆ†æå®Ÿè¡Œ</h3>
                    </div>
                    <div class="card-body">
                        <!-- åˆ†ææ‰‹æ³•ã®èª¬æ˜ -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="alert alert-info">
                                    <h5><i class="fas fa-info-circle me-2"></i>åˆ†ææ‰‹æ³•ã«ã¤ã„ã¦</h5>
                                    <p class="mb-2">æœ¬ã‚·ã‚¹ãƒ†ãƒ ã§ã¯ã€3ã¤ã®ç•°ãªã‚‹æ—¥æœ¬èªBERTæ„Ÿæƒ…åˆ†æãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨ã—ã¦ã€å‹•ç‰©ç—…é™¢ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼æ–‡ã®æ„Ÿæƒ…æ¥µæ€§ã‚’åˆ†æã—ã¾ã™ã€‚</p>
                                    <ul class="mb-2">
                                        <li><strong>BERTï¼ˆBidirectional Encoder Representations from Transformersï¼‰</strong>: Googleé–‹ç™ºã®è‡ªç„¶è¨€èªå‡¦ç†ãƒ¢ãƒ‡ãƒ«</li>
                                        <li><strong>æ„Ÿæƒ…æ¥µæ€§åˆ†æ</strong>: ãƒ†ã‚­ã‚¹ãƒˆã®æ„Ÿæƒ…ï¼ˆãƒã‚¸ãƒ†ã‚£ãƒ–/ãƒã‚¬ãƒ†ã‚£ãƒ–ï¼‰ã‚’-1ã€œ+1ã®ã‚¹ã‚³ã‚¢ã§æ•°å€¤åŒ–</li>
                                        <li><strong>æ­£è¦åŒ–å‡¦ç†</strong>: å„ãƒ¢ãƒ‡ãƒ«ã®å‡ºåŠ›ã‚’-2ã€œ+2ã®ç¯„å›²ã«æ­£è¦åŒ–ã—ã¦æ¯”è¼ƒå¯èƒ½ã«ã—ã¾ã™</li>
                                        <li><strong>ç›¸é–¢åˆ†æ</strong>: æ˜Ÿè©•ä¾¡ï¼ˆ1-5ï¼‰ã¨æ„Ÿæƒ…ã‚¹ã‚³ã‚¢ã®é–¢ä¿‚æ€§ã‚’çµ±è¨ˆçš„ã«è©•ä¾¡ã—ã¾ã™</li>
                                        <li><strong>ãƒ–ãƒ¼ãƒˆã‚¹ãƒˆãƒ©ãƒƒãƒ—æ³•ï¼ˆ10000å›ï¼‰</strong>: çµ±è¨ˆçš„ä¿¡é ¼åŒºé–“ã®æ¨å®šã«ä½¿ç”¨ã€‚ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒæŠ½å‡ºã—ã¦10000å›ã®å†ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã‚’è¡Œã„ã€ç›¸é–¢ä¿‚æ•°ã‚„MAEã®95%ä¿¡é ¼åŒºé–“ã‚’è¨ˆç®—ã—ã¾ã™</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-8">
                                <h5>ä½¿ç”¨ãƒ¢ãƒ‡ãƒ«</h5>
                                <div class="row">
                                    <div class="col-12">
                                        <div class="card border-primary mb-2">
                                            <div class="card-body p-3">
                                                <h6><i class="fas fa-robot me-2 text-primary"></i><strong>Model A (Koheiduck)</strong></h6>
                                                <p class="small text-muted mb-1">koheiduck/bert-japanese-finetuned-sentiment</p>
                                                <p class="small mb-0">æ—¥æœ¬èªæ„Ÿæƒ…åˆ†æã«ç‰¹åŒ–ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ³ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã•ã‚ŒãŸBERTãƒ¢ãƒ‡ãƒ«ã€‚å¹…åºƒã„æ—¥æœ¬èªãƒ†ã‚­ã‚¹ãƒˆã§ã®æ„Ÿæƒ…æ¥µæ€§åˆ¤å®šã«å„ªã‚ŒãŸæ€§èƒ½ã‚’ç™ºæ®ã€‚</p>
                                            </div>
                                        </div>
                                        <div class="card border-info mb-2">
                                            <div class="card-body p-3">
                                                <h6><i class="fas fa-robot me-2 text-info"></i><strong>Model B (LLM-book)</strong></h6>
                                                <p class="small text-muted mb-1">llm-book/bert-base-japanese-v2-finetuned-sentiment</p>
                                                <p class="small mb-0">ã€Œå¤§è¦æ¨¡è¨€èªãƒ¢ãƒ‡ãƒ«å…¥é–€ã€æ›¸ç±ã§ç´¹ä»‹ã•ã‚ŒãŸãƒ¢ãƒ‡ãƒ«ã€‚å­¦è¡“ç ”ç©¶ã§ã®å®Ÿç¸¾ãŒã‚ã‚Šã€ãƒãƒ©ãƒ³ã‚¹ã®å–ã‚ŒãŸæ„Ÿæƒ…åˆ†ææ€§èƒ½ã‚’æä¾›ã€‚</p>
                                            </div>
                                        </div>
                                        <div class="card border-success mb-2">
                                            <div class="card-body p-3">
                                                <h6><i class="fas fa-robot me-2 text-success"></i><strong>Model C (Mizuiro)</strong></h6>
                                                <p class="small text-muted mb-1">Mizuiro-inc/bert-base-japanese-finetuned-sentiment-analysis</p>
                                                <p class="small mb-0">å•†ç”¨åˆ©ç”¨ã‚’å¿µé ­ã«é–‹ç™ºã•ã‚ŒãŸãƒ¢ãƒ‡ãƒ«ã€‚å®Ÿç”¨çš„ãªã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã®é«˜ã„ç²¾åº¦ã¨å®‰å®šæ€§ã‚’é‡è¦–ã—ãŸè¨­è¨ˆã€‚</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 text-end">
                                <button id="analyzeBtn" class="btn btn-primary btn-lg" disabled>
                                    <i class="fas fa-play me-2"></i>åˆ†æé–‹å§‹
                                </button>
                            </div>
                        </div>
                        
                        <!-- åˆ†æé€²è¡ŒçŠ¶æ³ -->
                        <div id="analysisProgress" class="mt-3 d-none">
                            <div class="alert alert-info">
                                <i class="fas fa-spinner fa-spin me-2"></i>
                                <span id="progressText">åˆ†æã‚’å®Ÿè¡Œä¸­...</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 3: çµæœè¡¨ç¤º -->
                <div class="card mb-4" id="resultsSection" style="display: none;">
                    <div class="card-header bg-light">
                        <h3 class="card-title mb-0"><i class="fas fa-chart-bar me-2"></i>Step 3: åˆ†æçµæœ</h3>
                    </div>
                    <div class="card-body">
                        <!-- åˆ†æçµæœã®è§£é‡ˆã‚¬ã‚¤ãƒ‰ -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="alert alert-success">
                                    <h5><i class="fas fa-lightbulb me-2"></i>åˆ†æçµæœã®è§£é‡ˆæ–¹æ³•</h5>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6>ğŸ“Š ç›¸é–¢ä¿‚æ•° (r) ã®èª­ã¿æ–¹</h6>
                                            <ul class="small">
                                                <li><strong>r = 0.7ã€œ1.0</strong>: å¼·ã„æ­£ã®ç›¸é–¢ï¼ˆæ˜Ÿè©•ä¾¡â†‘â†’æ„Ÿæƒ…ã‚¹ã‚³ã‚¢â†‘ï¼‰</li>
                                                <li><strong>r = 0.3ã€œ0.7</strong>: ä¸­ç¨‹åº¦ã®æ­£ã®ç›¸é–¢</li>
                                                <li><strong>r = -0.3ã€œ0.3</strong>: å¼±ã„ç›¸é–¢ãƒ»ç„¡ç›¸é–¢</li>
                                                <li><strong>r = -1.0ã€œ-0.3</strong>: è² ã®ç›¸é–¢ï¼ˆæ˜Ÿè©•ä¾¡â†‘â†’æ„Ÿæƒ…ã‚¹ã‚³ã‚¢â†“ï¼‰</li>
                                            </ul>
                                        </div>
                                        <div class="col-md-6">
                                            <h6>ğŸ“ˆ æ„Ÿæƒ…ã‚¹ã‚³ã‚¢ã®èª­ã¿æ–¹</h6>
                                            <ul class="small">
                                                <li><strong>+1.5ã€œ+2.0</strong>: éå¸¸ã«ãƒã‚¸ãƒ†ã‚£ãƒ–</li>
                                                <li><strong>+0.5ã€œ+1.5</strong>: ãƒã‚¸ãƒ†ã‚£ãƒ–</li>
                                                <li><strong>-0.5ã€œ+0.5</strong>: ãƒ‹ãƒ¥ãƒ¼ãƒˆãƒ©ãƒ«</li>
                                                <li><strong>-1.5ã€œ-0.5</strong>: ãƒã‚¬ãƒ†ã‚£ãƒ–</li>
                                                <li><strong>-2.0ã€œ-1.5</strong>: éå¸¸ã«ãƒã‚¬ãƒ†ã‚£ãƒ–</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- åŸºæœ¬çµ±è¨ˆ -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5><i class="fas fa-info-circle me-2"></i>åŸºæœ¬çµ±è¨ˆ</h5>
                                <div id="basicStats"></div>
                            </div>
                        </div>
                        
                        <!-- MAEæ€§èƒ½è©•ä¾¡ -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5><i class="fas fa-calculator me-2"></i>ãƒ¢ãƒ‡ãƒ«æ€§èƒ½è©•ä¾¡ (MAE)</h5>
                                <div id="maeComparison"></div>
                            </div>
                        </div>
                        
                        <!-- ãƒãƒ£ãƒ¼ãƒˆè¡¨ç¤º -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <h5><i class="fas fa-chart-bar me-2"></i>ãƒ¢ãƒ‡ãƒ«æ€§èƒ½æ¯”è¼ƒ</h5>
                                <canvas id="modelChart"></canvas>
                            </div>
                            <div class="col-md-6">
                                <h5><i class="fas fa-star me-2"></i>æ˜Ÿè©•ä¾¡åˆ†å¸ƒ</h5>
                                <div style="height: 400px;">
                                    <canvas id="starRatingChart"></canvas>
                                </div>
                            </div>
                        </div>
                        
                        <!-- æ˜Ÿè©•ä¾¡vsæ„Ÿæƒ…ã‚¹ã‚³ã‚¢åˆ†å¸ƒ -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5><i class="fas fa-scatter-chart me-2"></i>æ˜Ÿè©•ä¾¡ã¨æ„Ÿæƒ…ã‚¹ã‚³ã‚¢åˆ†å¸ƒï¼ˆå›å¸°åˆ†æï¼‰</h5>
                                <div class="alert alert-light mb-3">
                                    <p class="mb-1"><strong>ğŸ“Š ã“ã®ã‚°ãƒ©ãƒ•ã®è¦‹æ–¹ï¼š</strong></p>
                                    <ul class="small mb-0">
                                        <li>å„ç‚¹ã¯1ã¤ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ã—ã€æ¨ªè»¸ãŒæ˜Ÿè©•ä¾¡ï¼ˆæ­£è¦åŒ–å¾Œï¼š-2ã€œ+2ï¼‰ã€ç¸¦è»¸ãŒæ„Ÿæƒ…ã‚¹ã‚³ã‚¢ï¼ˆ-2ã€œ+2ï¼‰</li>
                                        <li>èµ¤ã„ç‚¹ç·šã¯å›å¸°ç›´ç·šã§ã€å…¨ä½“çš„ãªå‚¾å‘ã‚’ç¤ºã—ã¾ã™</li>
                                        <li>ç‚¹ãŒå³ä¸Šã«å‘ã‹ã†ã»ã©ã€æ˜Ÿè©•ä¾¡ã¨æ„Ÿæƒ…ã‚¹ã‚³ã‚¢ãŒé€£å‹•ã—ã¦ã„ã‚‹ï¼ˆæ­£ã®ç›¸é–¢ï¼‰</li>
                                        <li>ç›¸é–¢ä¿‚æ•°(r)ãŒ0.7ä»¥ä¸Šãªã‚‰ã€ãã®ãƒ¢ãƒ‡ãƒ«ã¯æ˜Ÿè©•ä¾¡ã‚’è‰¯ãäºˆæ¸¬ã§ãã¦ã„ã¾ã™</li>
                                    </ul>
                                </div>
                                <div class="row">
                                    <div class="col-md-4">
                                        <div id="scatterChart1"></div>
                                    </div>
                                    <div class="col-md-4">
                                        <div id="scatterChart2"></div>
                                    </div>
                                    <div class="col-md-4">
                                        <div id="scatterChart3"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ç—…é™¢åˆ¥åˆ†æ -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5><i class="fas fa-hospital me-2"></i>ç—…é™¢åˆ¥åˆ†æ</h5>
                                <div id="hospitalAnalysis"></div>
                            </div>
                        </div>
                        
                        <!-- çµ±è¨ˆæ¤œå®šçµæœ -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5><i class="fas fa-chart-line me-2"></i>æ˜Ÿè©•ä¾¡ã¨æ„Ÿæƒ…ã‚¹ã‚³ã‚¢ç›¸é–¢åˆ†æ</h5>
                                <div id="correlationResults"></div>
                            </div>
                        </div>
                        
                        <!-- ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ -->
                        <div class="mt-4 text-center">
                            <button id="exportBtn" class="btn btn-success btn-lg">
                                <i class="fas fa-download me-2"></i>è©³ç´°çµæœã‚’CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                            </button>
                            <p class="text-muted mt-2">
                                <small>å„ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®æ„Ÿæƒ…ã‚¹ã‚³ã‚¢ã€æ˜Ÿè©•ä¾¡ã€ç—…é™¢IDã‚’å«ã‚€å®Œå…¨ãªãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ</small>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
        <footer class="bg-light text-center py-3 mt-5">
            <p class="mb-0 text-muted">å‹•ç‰©ç—…é™¢å£ã‚³ãƒŸåˆ†æã‚·ã‚¹ãƒ†ãƒ  - ç ”ç©¶æ”¯æ´ãƒ„ãƒ¼ãƒ«</p>
        </footer>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <!-- Full Featured JS -->
    <script>
        console.log('Full featured app loaded');
        console.log('Chart.js available:', typeof Chart);
        console.log('Plotly available:', typeof Plotly);
        
        let uploadedData = null;
        let analysisResults = null;
        
        // DOMèª­ã¿è¾¼ã¿å®Œäº†æ™‚ã®åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });
        
        function initializeApp() {
            const fileInput = document.getElementById('fileInput');
            const uploadArea = document.getElementById('uploadArea');
            const loadSampleBtn = document.getElementById('loadSampleBtn');
            const analyzeBtn = document.getElementById('analyzeBtn');
            const exportBtn = document.getElementById('exportBtn');
            
            if (fileInput) {
                fileInput.addEventListener('change', handleFileSelect);
            }
            
            if (uploadArea) {
                // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—æ©Ÿèƒ½
                uploadArea.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    uploadArea.classList.add('drag-over');
                });
                
                uploadArea.addEventListener('dragleave', function(e) {
                    e.preventDefault();
                    uploadArea.classList.remove('drag-over');
                });
                
                uploadArea.addEventListener('drop', function(e) {
                    e.preventDefault();
                    uploadArea.classList.remove('drag-over');
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        fileInput.files = files;
                        handleFileSelect();
                    }
                });
            }
            
            if (loadSampleBtn) {
                loadSampleBtn.addEventListener('click', loadSampleData);
            }
            
            if (analyzeBtn) {
                analyzeBtn.addEventListener('click', runFullAnalysis);
            }
            
            if (exportBtn) {
                exportBtn.addEventListener('click', exportResults);
            }
        }
        
        function handleFileSelect() {
            const file = document.getElementById('fileInput').files[0];
            if (file) {
                showProgress('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...');
                
                const formData = new FormData();
                formData.append('file', file);
                
                fetch('/upload', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    hideProgress();
                    if (data.success) {
                        uploadedData = data.data; // å®Ÿéš›ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
                        showDataStats(data.stats);
                        document.getElementById('analyzeBtn').disabled = false;
                        showUploadSuccess(file.name);
                    } else {
                        showError('ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼: ' + data.error);
                    }
                })
                .catch(error => {
                    hideProgress();
                    showError('é€šä¿¡ã‚¨ãƒ©ãƒ¼: ' + error.message);
                });
            }
        }
        
        function loadSampleData() {
            showProgress('ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...');
            
            fetch('/load_sample_data')
                .then(response => response.json())
                .then(data => {
                    hideProgress();
                    if (data.success) {
                        uploadedData = data.data; // å®Ÿéš›ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
                        showDataStats(data.stats);
                        document.getElementById('analyzeBtn').disabled = false;
                        showUploadSuccess('ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿');
                    } else {
                        showError('ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚¨ãƒ©ãƒ¼: ' + data.error);
                    }
                })
                .catch(error => {
                    hideProgress();
                    showError('é€šä¿¡ã‚¨ãƒ©ãƒ¼: ' + error.message);
                });
        }
        
        function runFullAnalysis() {
            if (!uploadedData) {
                showError('å…ˆã«ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„');
                return;
            }
            
            showProgress('æ„Ÿæƒ…åˆ†æã‚’å®Ÿè¡Œä¸­... (3ã¤ã®BERTãƒ¢ãƒ‡ãƒ«)');
            document.getElementById('analyzeBtn').disabled = true;
            
            fetch('/analyze', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({data: uploadedData})
            })
            .then(response => response.json())
            .then(data => {
                hideProgress();
                if (data.success) {
                    analysisResults = data.results;
                    displayFullResults(data.results);
                    document.getElementById('resultsSection').style.display = 'block';
                    document.getElementById('exportBtn').disabled = false;
                } else {
                    showError('åˆ†æã‚¨ãƒ©ãƒ¼: ' + data.error);
                }
                document.getElementById('analyzeBtn').disabled = false;
            })
            .catch(error => {
                hideProgress();
                showError('åˆ†æã‚¨ãƒ©ãƒ¼: ' + error.message);
                document.getElementById('analyzeBtn').disabled = false;
            });
        }
        
        function displayFullResults(results) {
            // åŸºæœ¬çµ±è¨ˆè¡¨ç¤º
            displayBasicStats(results.basic_stats);
            
            // MAEæ€§èƒ½æ¯”è¼ƒè¡¨ç¤º
            displayMAEComparison(results.model_comparison);
            
            // ãƒ¢ãƒ‡ãƒ«æ€§èƒ½æ¯”è¼ƒãƒãƒ£ãƒ¼ãƒˆ
            displayModelComparison(results.model_comparison);
            
            // æ˜Ÿè©•ä¾¡åˆ†å¸ƒãƒãƒ£ãƒ¼ãƒˆ
            displayStarDistribution(results.star_rating_distribution);
            
            // æ•£å¸ƒå›³è¡¨ç¤º
            displayScatterPlots(results.sentiment_correlation.scatter_data, results.sentiment_correlation.correlations);
            
            // ç—…é™¢åˆ¥åˆ†æè¡¨ç¤º
            displayHospitalAnalysis(results.hospital_analysis);
            
            // ç›¸é–¢åˆ†æçµæœè¡¨ç¤º
            displayCorrelationResults(results.sentiment_correlation.correlations);
        }
        
        function displayBasicStats(stats) {
            // çµ±è¨ˆçš„è§£é‡ˆã‚’è¿½åŠ 
            const ratingInterpretation = stats.avg_rating >= 4.0 ? "éå¸¸ã«è‰¯å¥½" : 
                                        stats.avg_rating >= 3.5 ? "è‰¯å¥½" :
                                        stats.avg_rating >= 3.0 ? "æ™®é€š" :
                                        stats.avg_rating >= 2.5 ? "ã‚„ã‚„ä¸è‰¯" : "ä¸è‰¯";
            
            const lengthInterpretation = stats.avg_review_length >= 100 ? "è©³ç´°ãªãƒ¬ãƒ“ãƒ¥ãƒ¼" :
                                        stats.avg_review_length >= 50 ? "æ¨™æº–çš„ãªãƒ¬ãƒ“ãƒ¥ãƒ¼" : "ç°¡æ½”ãªãƒ¬ãƒ“ãƒ¥ãƒ¼";
            
            document.getElementById('basicStats').innerHTML = `
                <div class="row mb-3">
                    <div class="col-md-2">
                        <div class="stat-card">
                            <div class="stat-value">${stats.total_reviews}</div>
                            <div class="stat-label">ç·å£ã‚³ãƒŸæ•°</div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="stat-card">
                            <div class="stat-value">${stats.unique_hospitals}</div>
                            <div class="stat-label">ç—…é™¢æ•°</div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="stat-card">
                            <div class="stat-value">${stats.avg_rating.toFixed(2)}</div>
                            <div class="stat-label">å¹³å‡æ˜Ÿè©•ä¾¡</div>
                            <div class="stat-interpretation text-small text-muted">${ratingInterpretation}</div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="stat-card">
                            <div class="stat-value">${stats.avg_review_length.toFixed(0)}</div>
                            <div class="stat-label">å¹³å‡æ–‡å­—æ•°</div>
                            <div class="stat-interpretation text-small text-muted">${lengthInterpretation}</div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="stat-card">
                            <div class="stat-value">${stats.rating_std.toFixed(2)}</div>
                            <div class="stat-label">æ˜Ÿè©•ä¾¡æ¨™æº–åå·®</div>
                            <div class="stat-interpretation text-small text-muted">ãƒ‡ãƒ¼ã‚¿ã®ã°ã‚‰ã¤ã</div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="stat-card">
                            <div class="stat-value">${stats.length_std.toFixed(0)}</div>
                            <div class="stat-label">æ–‡å­—æ•°æ¨™æº–åå·®</div>
                            <div class="stat-interpretation text-small text-muted">ãƒ¬ãƒ“ãƒ¥ãƒ¼é•·ã®å¤šæ§˜æ€§</div>
                        </div>
                    </div>
                </div>
                
                <!-- è©³ç´°çµ±è¨ˆ -->
                <div class="row mb-3">
                    <div class="col-12">
                        <h6><i class="fas fa-info-circle me-2"></i>ãƒ‡ãƒ¼ã‚¿åˆ†å¸ƒã®è©³ç´°</h6>
                        <div class="row">
                            <div class="col-md-3">
                                <small><strong>æ˜Ÿè©•ä¾¡ç¯„å›²:</strong> ${stats.min_rating} - ${stats.max_rating}</small>
                            </div>
                            <div class="col-md-3">
                                <small><strong>ä¸­å¤®å€¤:</strong> ${stats.median_rating}</small>
                            </div>
                            <div class="col-md-3">
                                <small><strong>æœ€çŸ­ãƒ¬ãƒ“ãƒ¥ãƒ¼:</strong> ${stats.min_length}æ–‡å­—</small>
                            </div>
                            <div class="col-md-3">
                                <small><strong>æœ€é•·ãƒ¬ãƒ“ãƒ¥ãƒ¼:</strong> ${stats.max_length}æ–‡å­—</small>
                            </div>
                        </div>
                    </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function displayMAEComparison(modelComparison) {
            let html = '<div class="alert alert-warning mb-3">';
            html += '<h6><i class="fas fa-calculator me-2"></i>å¹³å‡çµ¶å¯¾èª¤å·® (MAE) æ€§èƒ½è©•ä¾¡</h6>';
            
            // MAEã®æœ€å°å€¤ã‚’è¦‹ã¤ã‘ã‚‹
            let bestMAE = Math.min(...Object.values(modelComparison).map(m => m.mae));
            let bestModel = Object.keys(modelComparison).find(model => modelComparison[model].mae === bestMAE);
            
            html += `<p class="mb-1"><strong>ğŸ“ˆ æœ€é«˜æ€§èƒ½ãƒ¢ãƒ‡ãƒ«:</strong> <span class="text-success">${bestModel}</span> (MAE = ${bestMAE.toFixed(3)})</p>`;
            html += '<p class="small mb-0"><strong>MAEã¨ã¯:</strong> äºˆæ¸¬å€¤ã¨å®Ÿæ¸¬å€¤ã®å¹³å‡çµ¶å¯¾èª¤å·®ã€‚å€¤ãŒå°ã•ã„ã»ã©äºˆæ¸¬ç²¾åº¦ãŒé«˜ã„ã€‚</p>';
            html += '</div>';
            
            html += '<div class="table-responsive"><table class="table table-striped table-hover">';
            html += '<thead class="table-dark"><tr><th>ãƒ¢ãƒ‡ãƒ«</th><th>MAE</th><th>ç›¸é–¢ä¿‚æ•° (r)</th><th>æ€§èƒ½ãƒ©ãƒ³ã‚¯</th><th>ç·åˆè©•ä¾¡</th></tr></thead><tbody>';
            
            // MAEã§ã‚½ãƒ¼ãƒˆã—ã¦ãƒ©ãƒ³ã‚­ãƒ³ã‚°
            const sortedModels = Object.entries(modelComparison)
                .sort((a, b) => a[1].mae - b[1].mae)
                .map(([model, data], index) => ({
                    model,
                    mae: data.mae,
                    correlation: data.correlation,
                    rank: index + 1
                }));
            
            sortedModels.forEach((item, index) => {
                const performanceLevel = item.mae <= 0.5 ? "å„ªç§€" : 
                                       item.mae <= 1.0 ? "è‰¯å¥½" : 
                                       item.mae <= 1.5 ? "æ™®é€š" : "è¦æ”¹å–„";
                
                const rankColor = index === 0 ? "text-success" : 
                                 index === 1 ? "text-warning" : "text-danger";
                
                const rankBadge = index === 0 ? '<span class="badge bg-success">1ä½</span>' :
                                 index === 1 ? '<span class="badge bg-warning">2ä½</span>' :
                                 '<span class="badge bg-secondary">3ä½</span>';
                
                html += `<tr>
                    <td><strong>${item.model}</strong></td>
                    <td class="${rankColor}">${item.mae.toFixed(3)}</td>
                    <td>${item.correlation.toFixed(3)}</td>
                    <td>${rankBadge}</td>
                    <td class="${rankColor}">${performanceLevel}</td>
                </tr>`;
            });
            
            html += '</tbody></table></div>';
            document.getElementById('maeComparison').innerHTML = html;
        }
        
        function displayModelComparison(modelComparison) {
            const labels = Object.keys(modelComparison);
            const maeData = labels.map(model => modelComparison[model].mae);
            const correlationData = labels.map(model => modelComparison[model].correlation);
            
            const ctx = document.getElementById('modelChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'MAE (ä½ã„ã»ã©è‰¯ã„)',
                        data: maeData,
                        backgroundColor: 'rgba(54, 162, 235, 0.8)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        function displayStarDistribution(distribution) {
            const labels = Object.keys(distribution).sort();
            const data = labels.map(star => distribution[star]);
            
            const ctx = document.getElementById('starRatingChart').getContext('2d');
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels.map(star => `${star}æ˜Ÿ`),
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.8)',
                            'rgba(54, 162, 235, 0.8)',
                            'rgba(255, 205, 86, 0.8)',
                            'rgba(75, 192, 192, 0.8)',
                            'rgba(153, 102, 255, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 12,
                                font: {
                                    size: 14
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((sum, val) => sum + val, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: ${value}ä»¶ (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function displayScatterPlots(scatterData, correlations) {
            const models = Object.keys(scatterData);
            
            models.forEach((model, index) => {
                const chartId = `scatterChart${index + 1}`;
                const data = scatterData[model];
                const corr = correlations[model];
                
                // æ•£å¸ƒå›³ã®ãƒˆãƒ¬ãƒ¼ã‚¹
                const scatterTrace = {
                    x: data.star_ratings,
                    y: data.sentiment_scores,
                    mode: 'markers',
                    type: 'scatter',
                    name: 'ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ãƒˆ',
                    marker: {
                        size: 8,
                        color: ['rgba(255, 99, 132, 0.8)', 'rgba(54, 162, 235, 0.8)', 'rgba(75, 192, 192, 0.8)'][index]
                    }
                };
                
                // å›å¸°ç›´ç·šã®è¨ˆç®—
                const n = data.star_ratings.length;
                const sumX = data.star_ratings.reduce((a, b) => a + b, 0);
                const sumY = data.sentiment_scores.reduce((a, b) => a + b, 0);
                const sumXY = data.star_ratings.reduce((sum, x, i) => sum + x * data.sentiment_scores[i], 0);
                const sumX2 = data.star_ratings.reduce((sum, x) => sum + x * x, 0);
                
                const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
                const intercept = (sumY - slope * sumX) / n;
                
                // å›å¸°ç›´ç·šã®ãƒã‚¤ãƒ³ãƒˆï¼ˆXè»¸ç¯„å›²ï¼š-2ï½+2ï¼‰
                const xRange = [-2, -1, 0, 1, 2];
                const yRegression = xRange.map(x => slope * x + intercept);
                
                // å›å¸°ç›´ç·šã®ãƒˆãƒ¬ãƒ¼ã‚¹
                const regressionTrace = {
                    x: xRange,
                    y: yRegression,
                    mode: 'lines',
                    type: 'scatter',
                    name: 'å›å¸°ç›´ç·š',
                    line: {
                        color: 'red',
                        width: 2,
                        dash: 'dot'
                    }
                };
                
                const layout = {
                    title: `${model}<br>ç›¸é–¢ä¿‚æ•° r = ${corr.correlation.toFixed(3)}`,
                    xaxis: { 
                        title: 'æ˜Ÿè©•ä¾¡ï¼ˆæ­£è¦åŒ–å¾Œï¼‰',
                        range: [-2.2, 2.2],
                        dtick: 1
                    },
                    yaxis: { 
                        title: 'æ„Ÿæƒ…ã‚¹ã‚³ã‚¢ï¼ˆæ­£è¦åŒ–å¾Œï¼‰',
                        range: [-2.2, 2.2]
                    },
                    height: 450,
                    width: 400,
                    showlegend: true,
                    margin: {
                        l: 60,
                        r: 40,
                        t: 80,
                        b: 60
                    },
                    legend: {
                        x: 0.02,
                        y: 0.98,
                        bgcolor: 'rgba(255,255,255,0.8)'
                    }
                };
                
                Plotly.newPlot(chartId, [scatterTrace, regressionTrace], layout);
            });
        }
        
        function displayHospitalAnalysis(hospitalAnalysis) {
            let html = '<div class="alert alert-info mb-3">';
            html += '<h6><i class="fas fa-hospital me-2"></i>ç—…é™¢åˆ¥æ„Ÿæƒ…ã‚¹ã‚³ã‚¢è©³ç´°</h6>';
            html += '<p class="small mb-0">å„BERTãƒ¢ãƒ‡ãƒ«ã®æ„Ÿæƒ…ã‚¹ã‚³ã‚¢ï¼ˆæ­£è¦åŒ–æ¸ˆã¿ï¼š-2ï½+2ï¼‰ã¨3ãƒ¢ãƒ‡ãƒ«ã®å¹³å‡å€¤ã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™ã€‚</p>';
            html += '</div>';
            
            html += '<div class="table-responsive"><table class="table table-striped table-hover">';
            html += '<thead class="table-dark"><tr>';
            html += '<th>ç—…é™¢ID</th>';
            html += '<th>å£ã‚³ãƒŸæ•°</th>';
            html += '<th>å¹³å‡æ˜Ÿè©•ä¾¡<br><small class="text-muted">ï¼ˆæ­£è¦åŒ–å¾Œï¼‰</small></th>';
            html += '<th>Model A<br><small class="text-muted">(Koheiduck)</small></th>';
            html += '<th>Model B<br><small class="text-muted">(LLM-book)</small></th>';
            html += '<th>Model C<br><small class="text-muted">(Mizuiro)</small></th>';
            html += '<th>å¹³å‡æ„Ÿæƒ…ã‚¹ã‚³ã‚¢<br><small class="text-muted">ï¼ˆ3ãƒ¢ãƒ‡ãƒ«å¹³å‡ï¼‰</small></th>';
            html += '</tr></thead><tbody>';
            
            Object.keys(hospitalAnalysis).forEach(hospitalId => {
                const data = hospitalAnalysis[hospitalId];
                const models = data.model_sentiments || {};
                
                // å„ãƒ¢ãƒ‡ãƒ«ã®æ„Ÿæƒ…ã‚¹ã‚³ã‚¢ã‚’å–å¾—
                const modelA = models['Model A (Koheiduck)'] || 0;
                const modelB = models['Model B (LLM-book)'] || 0;
                const modelC = models['Model C (Mizuiro)'] || 0;
                
                // è‰²åˆ†ã‘ç”¨ã®é–¢æ•°
                const getSentimentColor = (score) => {
                    if (score >= 1.0) return 'text-success';
                    if (score >= 0.5) return 'text-info';
                    if (score >= -0.5) return 'text-secondary';
                    if (score >= -1.0) return 'text-warning';
                    return 'text-danger';
                };
                
                html += `<tr>
                    <td><strong>${hospitalId}</strong></td>
                    <td>${data.review_count}</td>
                    <td class="${data.avg_rating >= 0 ? 'text-success' : 'text-danger'}">${data.avg_rating.toFixed(2)}</td>
                    <td class="${getSentimentColor(modelA)}">${modelA.toFixed(3)}</td>
                    <td class="${getSentimentColor(modelB)}">${modelB.toFixed(3)}</td>
                    <td class="${getSentimentColor(modelC)}">${modelC.toFixed(3)}</td>
                    <td class="${getSentimentColor(data.avg_sentiment)}"><strong>${data.avg_sentiment.toFixed(3)}</strong></td>
                </tr>`;
            });
            
            html += '</tbody></table></div>';
            
            // æ„Ÿæƒ…ã‚¹ã‚³ã‚¢è§£é‡ˆã‚¬ã‚¤ãƒ‰
            html += '<div class="row mt-3">';
            html += '<div class="col-12">';
            html += '<div class="alert alert-light">';
            html += '<h6><i class="fas fa-info-circle me-2"></i>æ„Ÿæƒ…ã‚¹ã‚³ã‚¢è§£é‡ˆã‚¬ã‚¤ãƒ‰</h6>';
            html += '<div class="row small">';
            html += '<div class="col-md-6">';
            html += '<ul class="mb-0">';
            html += '<li><span class="text-success">+1.0ä»¥ä¸Š</span>: éå¸¸ã«ãƒã‚¸ãƒ†ã‚£ãƒ–</li>';
            html += '<li><span class="text-info">+0.5ã€œ+1.0</span>: ãƒã‚¸ãƒ†ã‚£ãƒ–</li>';
            html += '<li><span class="text-secondary">-0.5ã€œ+0.5</span>: ãƒ‹ãƒ¥ãƒ¼ãƒˆãƒ©ãƒ«</li>';
            html += '</ul>';
            html += '</div>';
            html += '<div class="col-md-6">';
            html += '<ul class="mb-0">';
            html += '<li><span class="text-warning">-1.0ã€œ-0.5</span>: ãƒã‚¬ãƒ†ã‚£ãƒ–</li>';
            html += '<li><span class="text-danger">-1.0æœªæº€</span>: éå¸¸ã«ãƒã‚¬ãƒ†ã‚£ãƒ–</li>';
            html += '</ul>';
            html += '</div>';
            html += '</div>';
            html += '</div>';
            html += '</div>';
            html += '</div>';
            
            document.getElementById('hospitalAnalysis').innerHTML = html;
        }
        
        function displayCorrelationResults(correlations) {
            let html = '<div class="alert alert-info mb-3">';
            html += '<h6><i class="fas fa-chart-line me-2"></i>ç›¸é–¢åˆ†æçµæœã®è§£é‡ˆ</h6>';
            
            // ç›¸é–¢ä¿‚æ•°ã®çµ±è¨ˆè¨ˆç®—
            const correlationValues = Object.values(correlations).map(data => data.correlation);
            const bestCorrelation = Math.max(...correlationValues);
            const worstCorrelation = Math.min(...correlationValues);
            const avgCorrelation = correlationValues.reduce((sum, val) => sum + val, 0) / correlationValues.length;
            
            const bestModel = Object.keys(correlations).find(model => correlations[model].correlation === bestCorrelation);
            const worstModel = Object.keys(correlations).find(model => correlations[model].correlation === worstCorrelation);
            
            html += `<p class="mb-1"><strong>ğŸ“Š åˆ†æçµæœã‚µãƒãƒªãƒ¼:</strong></p>`;
            html += `<ul class="mb-1">`;
            html += `<li>æœ€é«˜ç›¸é–¢ãƒ¢ãƒ‡ãƒ«: <strong>${bestModel}</strong> (r=${bestCorrelation.toFixed(3)})</li>`;
            html += `<li>æœ€ä½ç›¸é–¢ãƒ¢ãƒ‡ãƒ«: <strong>${worstModel}</strong> (r=${worstCorrelation.toFixed(3)})</li>`;
            
            const correlationLevel = avgCorrelation >= 0.7 ? "å¼·ã„ç›¸é–¢" : avgCorrelation >= 0.5 ? "ä¸­ç¨‹åº¦ã®ç›¸é–¢" : avgCorrelation >= 0.3 ? "å¼±ã„ç›¸é–¢" : "ç›¸é–¢ãªã—";
            html += `<li>å…¨ä½“çš„ãªç›¸é–¢ã®å¼·ã•: <strong>${correlationLevel}</strong> (å¹³å‡r=${avgCorrelation.toFixed(3)})</li></ul>`;
            html += '</div>';
            
            html += '<div class="table-responsive"><table class="table table-striped">';
            html += '<thead><tr><th>ãƒ¢ãƒ‡ãƒ«</th><th>ç›¸é–¢ä¿‚æ•°</th><th>ç›¸é–¢ã®å¼·ã•</th><th>95%ä¿¡é ¼åŒºé–“</th><th>çµ±è¨ˆçš„æœ‰æ„æ€§</th><th>è§£é‡ˆ</th></tr></thead><tbody>';
            
            Object.keys(correlations).forEach(model => {
                const data = correlations[model];
                const r = data.correlation;
                
                // ç›¸é–¢ã®å¼·ã•ã‚’åˆ¤å®š
                const strength = r >= 0.7 ? "å¼·ã„æ­£ã®ç›¸é–¢" : 
                               r >= 0.5 ? "ä¸­ç¨‹åº¦ã®æ­£ã®ç›¸é–¢" :
                               r >= 0.3 ? "å¼±ã„æ­£ã®ç›¸é–¢" :
                               r >= -0.3 ? "ç›¸é–¢ãªã—" :
                               r >= -0.5 ? "å¼±ã„è² ã®ç›¸é–¢" :
                               r >= -0.7 ? "ä¸­ç¨‹åº¦ã®è² ã®ç›¸é–¢" : "å¼·ã„è² ã®ç›¸é–¢";
                
                // å®Ÿç”¨æ€§ã‚’åˆ¤å®š
                const interpretation = r >= 0.6 ? "å®Ÿç”¨æ€§é«˜ï¼šæ˜Ÿè©•ä¾¡ã‚’è‰¯ãäºˆæ¸¬" :
                                     r >= 0.4 ? "å®Ÿç”¨æ€§ä¸­ï¼šã‚ã‚‹ç¨‹åº¦äºˆæ¸¬å¯èƒ½" :
                                     r >= 0.2 ? "å®Ÿç”¨æ€§ä½ï¼šäºˆæ¸¬ç²¾åº¦ã¯é™å®šçš„" : "å®Ÿç”¨æ€§ãªã—ï¼šäºˆæ¸¬ã«ä¸é©";
                
                const strengthColor = r >= 0.6 ? "text-success" : r >= 0.4 ? "text-warning" : "text-danger";
                
                html += `<tr>
                    <td><strong>${model}</strong></td>
                    <td class="${strengthColor}"><strong>${r.toFixed(3)}</strong></td>
                    <td class="${strengthColor}">${strength}</td>
                    <td>[${data.ci_lower.toFixed(3)}, ${data.ci_upper.toFixed(3)}]</td>
                    <td>${data.significant ? '<span class="badge bg-success">æœ‰æ„</span>' : '<span class="badge bg-secondary">éæœ‰æ„</span>'} (p=${data.p_value.toFixed(3)})</td>
                    <td class="small">${interpretation}</td>
                </tr>`;
            });
            
            html += '</tbody></table></div>';
            document.getElementById('correlationResults').innerHTML = html;
        }
        
        function exportResults() {
            if (!analysisResults) {
                showError('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹çµæœãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            
            showProgress('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆä¸­...');
            
            fetch('/export_results', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({results: analysisResults})
            })
            .then(response => {
                if (response.ok) {
                    return response.blob();
                }
                throw new Error('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ');
            })
            .then(blob => {
                hideProgress();
                
                // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `å‹•ç‰©ç—…é™¢å£ã‚³ãƒŸåˆ†æçµæœ_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                showSuccess('CSVãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãŒå®Œäº†ã—ã¾ã—ãŸ');
            })
            .catch(error => {
                hideProgress();
                showError('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼: ' + error.message);
            });
        }
        
        function showDataStats(stats) {
            document.getElementById('totalReviews').textContent = stats.total_reviews;
            document.getElementById('uniqueHospitals').textContent = stats.unique_hospitals;
            document.getElementById('avgStarRating').textContent = stats.avg_star_rating.toFixed(2);
            document.getElementById('dataStats').classList.remove('d-none');
        }
        
        function showUploadSuccess(fileName) {
            const uploadArea = document.getElementById('uploadArea');
            uploadArea.innerHTML = `
                <div class="alert alert-success border-0 mb-0">
                    <div class="text-center">
                        <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                        <h5 class="mb-2"><strong>ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†</strong></h5>
                        <p class="mb-2">${fileName}</p>
                        <button class="btn btn-outline-primary btn-sm" onclick="resetUpload()">
                            <i class="fas fa-undo me-1"></i>åˆ¥ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
                        </button>
                    </div>
                </div>
            `;
        }
        
        function resetUpload() {
            location.reload();
        }
        
        function showProgress(message) {
            document.getElementById('analysisProgress').classList.remove('d-none');
            document.getElementById('progressText').textContent = message;
        }
        
        function hideProgress() {
            document.getElementById('analysisProgress').classList.add('d-none');
        }
        
        function showError(message) {
            alert('ã‚¨ãƒ©ãƒ¼: ' + message);
        }
        
        function showSuccess(message) {
            alert('æˆåŠŸ: ' + message);
        }
    </script>
</body>
</html>