<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>動物病院口コミ分析システム</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container-fluid">
        <!-- ヘッダー -->
        <header class="bg-primary text-white p-4 mb-4">
            <h1 class="h2 mb-0"><i class="fas fa-chart-line me-2"></i>動物病院口コミ分析システム</h1>
            <p class="mb-0 mt-2">Japanese BERT Models Performance Analysis for Veterinary Hospital Reviews</p>
        </header>

        <!-- メインコンテンツ -->
        <div class="row">
            <div class="col-12">
                <!-- Step 1: データアップロード -->
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h3 class="card-title mb-0"><i class="fas fa-upload me-2"></i>Step 1: データアップロード</h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="upload-area border rounded p-4 text-center" id="uploadArea">
                                    <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                                    <h5>CSVファイルをアップロード</h5>
                                    <p class="text-muted">ファイルをドラッグ&ドロップするか、クリックして選択してください</p>
                                    <input type="file" id="fileInput" accept=".csv" class="d-none">
                                    <button class="btn btn-outline-primary me-2" onclick="document.getElementById('fileInput').click()">
                                        <i class="fas fa-folder-open me-1"></i>ファイルを選択
                                    </button>
                                    <button class="btn btn-outline-success" id="loadSampleBtn">
                                        <i class="fas fa-download me-1"></i>サンプル使用
                                    </button>
                                </div>
                                <div class="mt-3">
                                    <div class="alert alert-info mb-0">
                                        <small><strong>必要な列:</strong> hospital_id, review_text, star_rating (1-5)</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div id="dataStats" class="d-none">
                                    <h5><i class="fas fa-info-circle me-2"></i>データ概要</h5>
                                    <div class="row">
                                        <div class="col-6">
                                            <div class="stat-card">
                                                <div class="stat-value" id="totalReviews">-</div>
                                                <div class="stat-label">総口コミ数</div>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="stat-card">
                                                <div class="stat-value" id="uniqueHospitals">-</div>
                                                <div class="stat-label">病院数</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row mt-2">
                                        <div class="col-12">
                                            <div class="stat-card">
                                                <div class="stat-value" id="avgStarRating">-</div>
                                                <div class="stat-label">平均星評価</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 2: 感情分析実行 -->
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h3 class="card-title mb-0"><i class="fas fa-brain me-2"></i>Step 2: 感情分析実行</h3>
                    </div>
                    <div class="card-body">
                        <!-- 分析手法の説明 -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="alert alert-info">
                                    <h5><i class="fas fa-info-circle me-2"></i>分析手法について</h5>
                                    <p class="mb-2">本システムでは、3つの異なる日本語BERT感情分析モデルを使用して、動物病院のレビュー文の感情極性を分析します。</p>
                                    <ul class="mb-2">
                                        <li><strong>BERT（Bidirectional Encoder Representations from Transformers）</strong>: Google開発の自然言語処理モデル</li>
                                        <li><strong>感情極性分析</strong>: テキストの感情（ポジティブ/ネガティブ）を-1〜+1のスコアで数値化</li>
                                        <li><strong>正規化処理</strong>: 各モデルの出力を-2〜+2の範囲に正規化して比較可能にします</li>
                                        <li><strong>相関分析</strong>: 星評価（1-5）と感情スコアの関係性を統計的に評価します</li>
                                        <li><strong>ブートストラップ法（10000回）</strong>: 統計的信頼区間の推定に使用。データを復元抽出して10000回の再サンプリングを行い、相関係数やMAEの95%信頼区間を計算します</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-8">
                                <h5>使用モデル</h5>
                                <div class="row">
                                    <div class="col-12">
                                        <div class="card border-primary mb-2">
                                            <div class="card-body p-3">
                                                <h6><i class="fas fa-robot me-2 text-primary"></i><strong>Model A (Koheiduck)</strong></h6>
                                                <p class="small text-muted mb-1">koheiduck/bert-japanese-finetuned-sentiment</p>
                                                <p class="small mb-0">日本語感情分析に特化してファインチューニングされたBERTモデル。幅広い日本語テキストでの感情極性判定に優れた性能を発揮。</p>
                                            </div>
                                        </div>
                                        <div class="card border-info mb-2">
                                            <div class="card-body p-3">
                                                <h6><i class="fas fa-robot me-2 text-info"></i><strong>Model B (LLM-book)</strong></h6>
                                                <p class="small text-muted mb-1">llm-book/bert-base-japanese-v2-finetuned-sentiment</p>
                                                <p class="small mb-0">「大規模言語モデル入門」書籍で紹介されたモデル。学術研究での実績があり、バランスの取れた感情分析性能を提供。</p>
                                            </div>
                                        </div>
                                        <div class="card border-success mb-2">
                                            <div class="card-body p-3">
                                                <h6><i class="fas fa-robot me-2 text-success"></i><strong>Model C (Mizuiro)</strong></h6>
                                                <p class="small text-muted mb-1">Mizuiro-inc/bert-base-japanese-finetuned-sentiment-analysis</p>
                                                <p class="small mb-0">商用利用を念頭に開発されたモデル。実用的なアプリケーションでの高い精度と安定性を重視した設計。</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 text-end">
                                <button id="analyzeBtn" class="btn btn-primary btn-lg" disabled>
                                    <i class="fas fa-play me-2"></i>分析開始
                                </button>
                            </div>
                        </div>
                        
                        <!-- 分析進行状況 -->
                        <div id="analysisProgress" class="mt-3 d-none">
                            <div class="alert alert-info">
                                <i class="fas fa-spinner fa-spin me-2"></i>
                                <span id="progressText">分析を実行中...</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 3: 結果表示 -->
                <div class="card mb-4" id="resultsSection" style="display: none;">
                    <div class="card-header bg-light">
                        <h3 class="card-title mb-0"><i class="fas fa-chart-bar me-2"></i>Step 3: 分析結果</h3>
                    </div>
                    <div class="card-body">
                        <!-- 分析結果の解釈ガイド -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="alert alert-success">
                                    <h5><i class="fas fa-lightbulb me-2"></i>分析結果の解釈方法</h5>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6>📊 相関係数 (r) の読み方</h6>
                                            <ul class="small">
                                                <li><strong>r = 0.7〜1.0</strong>: 強い正の相関（星評価↑→感情スコア↑）</li>
                                                <li><strong>r = 0.3〜0.7</strong>: 中程度の正の相関</li>
                                                <li><strong>r = -0.3〜0.3</strong>: 弱い相関・無相関</li>
                                                <li><strong>r = -1.0〜-0.3</strong>: 負の相関（星評価↑→感情スコア↓）</li>
                                            </ul>
                                        </div>
                                        <div class="col-md-6">
                                            <h6>📈 感情スコアの読み方</h6>
                                            <ul class="small">
                                                <li><strong>+1.5〜+2.0</strong>: 非常にポジティブ</li>
                                                <li><strong>+0.5〜+1.5</strong>: ポジティブ</li>
                                                <li><strong>-0.5〜+0.5</strong>: ニュートラル</li>
                                                <li><strong>-1.5〜-0.5</strong>: ネガティブ</li>
                                                <li><strong>-2.0〜-1.5</strong>: 非常にネガティブ</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 基本統計 -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5><i class="fas fa-info-circle me-2"></i>基本統計</h5>
                                <div id="basicStats"></div>
                            </div>
                        </div>
                        
                        <!-- MAE性能評価 -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5><i class="fas fa-calculator me-2"></i>モデル性能評価 (MAE)</h5>
                                <div id="maeComparison"></div>
                            </div>
                        </div>
                        
                        <!-- チャート表示 -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <h5><i class="fas fa-chart-bar me-2"></i>モデル性能比較</h5>
                                <canvas id="modelChart"></canvas>
                            </div>
                            <div class="col-md-6">
                                <h5><i class="fas fa-star me-2"></i>星評価分布</h5>
                                <div style="height: 400px;">
                                    <canvas id="starRatingChart"></canvas>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 星評価vs感情スコア分布 -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5><i class="fas fa-scatter-chart me-2"></i>星評価と感情スコア分布（回帰分析）</h5>
                                <div class="alert alert-light mb-3">
                                    <p class="mb-1"><strong>📊 このグラフの見方：</strong></p>
                                    <ul class="small mb-0">
                                        <li>各点は1つのレビューを表し、横軸が星評価（正規化後：-2〜+2）、縦軸が感情スコア（-2〜+2）</li>
                                        <li>赤い点線は回帰直線で、全体的な傾向を示します</li>
                                        <li>点が右上に向かうほど、星評価と感情スコアが連動している（正の相関）</li>
                                        <li>相関係数(r)が0.7以上なら、そのモデルは星評価を良く予測できています</li>
                                    </ul>
                                </div>
                                <div class="row">
                                    <div class="col-md-4">
                                        <div id="scatterChart1"></div>
                                    </div>
                                    <div class="col-md-4">
                                        <div id="scatterChart2"></div>
                                    </div>
                                    <div class="col-md-4">
                                        <div id="scatterChart3"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 病院別分析 -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5><i class="fas fa-hospital me-2"></i>病院別分析</h5>
                                <div id="hospitalAnalysis"></div>
                            </div>
                        </div>
                        
                        <!-- 統計検定結果 -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5><i class="fas fa-chart-line me-2"></i>星評価と感情スコア相関分析</h5>
                                <div id="correlationResults"></div>
                            </div>
                        </div>
                        
                        <!-- エクスポート -->
                        <div class="mt-4 text-center">
                            <button id="exportBtn" class="btn btn-success btn-lg">
                                <i class="fas fa-download me-2"></i>詳細結果をCSVエクスポート
                            </button>
                            <p class="text-muted mt-2">
                                <small>各レビューの感情スコア、星評価、病院IDを含む完全なデータセット</small>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- フッター -->
        <footer class="bg-light text-center py-3 mt-5">
            <p class="mb-0 text-muted">動物病院口コミ分析システム - 研究支援ツール</p>
        </footer>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <!-- Full Featured JS -->
    <script>
        console.log('Full featured app loaded');
        console.log('Chart.js available:', typeof Chart);
        console.log('Plotly available:', typeof Plotly);
        
        let uploadedData = null;
        let analysisResults = null;
        
        // DOM読み込み完了時の初期化
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });
        
        function initializeApp() {
            const fileInput = document.getElementById('fileInput');
            const uploadArea = document.getElementById('uploadArea');
            const loadSampleBtn = document.getElementById('loadSampleBtn');
            const analyzeBtn = document.getElementById('analyzeBtn');
            const exportBtn = document.getElementById('exportBtn');
            
            if (fileInput) {
                fileInput.addEventListener('change', handleFileSelect);
            }
            
            if (uploadArea) {
                // ドラッグ&ドロップ機能
                uploadArea.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    uploadArea.classList.add('drag-over');
                });
                
                uploadArea.addEventListener('dragleave', function(e) {
                    e.preventDefault();
                    uploadArea.classList.remove('drag-over');
                });
                
                uploadArea.addEventListener('drop', function(e) {
                    e.preventDefault();
                    uploadArea.classList.remove('drag-over');
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        fileInput.files = files;
                        handleFileSelect();
                    }
                });
            }
            
            if (loadSampleBtn) {
                loadSampleBtn.addEventListener('click', loadSampleData);
            }
            
            if (analyzeBtn) {
                analyzeBtn.addEventListener('click', runFullAnalysis);
            }
            
            if (exportBtn) {
                exportBtn.addEventListener('click', exportResults);
            }
        }
        
        function handleFileSelect() {
            const file = document.getElementById('fileInput').files[0];
            if (file) {
                showProgress('ファイルをアップロード中...');
                
                const formData = new FormData();
                formData.append('file', file);
                
                fetch('/upload', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    hideProgress();
                    if (data.success) {
                        uploadedData = data.data; // 実際のレビューデータを保存
                        showDataStats(data.stats);
                        document.getElementById('analyzeBtn').disabled = false;
                        showUploadSuccess(file.name);
                    } else {
                        showError('ファイルアップロードエラー: ' + data.error);
                    }
                })
                .catch(error => {
                    hideProgress();
                    showError('通信エラー: ' + error.message);
                });
            }
        }
        
        function loadSampleData() {
            showProgress('サンプルデータを読み込み中...');
            
            fetch('/load_sample_data')
                .then(response => response.json())
                .then(data => {
                    hideProgress();
                    if (data.success) {
                        uploadedData = data.data; // 実際のレビューデータを保存
                        showDataStats(data.stats);
                        document.getElementById('analyzeBtn').disabled = false;
                        showUploadSuccess('サンプルデータ');
                    } else {
                        showError('サンプルデータエラー: ' + data.error);
                    }
                })
                .catch(error => {
                    hideProgress();
                    showError('通信エラー: ' + error.message);
                });
        }
        
        function runFullAnalysis() {
            if (!uploadedData) {
                showError('先にデータをアップロードしてください');
                return;
            }
            
            showProgress('感情分析を実行中... (3つのBERTモデル)');
            document.getElementById('analyzeBtn').disabled = true;
            
            fetch('/analyze', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({data: uploadedData})
            })
            .then(response => response.json())
            .then(data => {
                hideProgress();
                if (data.success) {
                    analysisResults = data.results;
                    displayFullResults(data.results);
                    document.getElementById('resultsSection').style.display = 'block';
                    document.getElementById('exportBtn').disabled = false;
                } else {
                    showError('分析エラー: ' + data.error);
                }
                document.getElementById('analyzeBtn').disabled = false;
            })
            .catch(error => {
                hideProgress();
                showError('分析エラー: ' + error.message);
                document.getElementById('analyzeBtn').disabled = false;
            });
        }
        
        function displayFullResults(results) {
            // 基本統計表示
            displayBasicStats(results.basic_stats);
            
            // MAE性能比較表示
            displayMAEComparison(results.model_comparison);
            
            // モデル性能比較チャート
            displayModelComparison(results.model_comparison);
            
            // 星評価分布チャート
            displayStarDistribution(results.star_rating_distribution);
            
            // 散布図表示
            displayScatterPlots(results.sentiment_correlation.scatter_data, results.sentiment_correlation.correlations);
            
            // 病院別分析表示
            displayHospitalAnalysis(results.hospital_analysis);
            
            // 相関分析結果表示
            displayCorrelationResults(results.sentiment_correlation.correlations);
        }
        
        function displayBasicStats(stats) {
            // 統計的解釈を追加
            const ratingInterpretation = stats.avg_rating >= 4.0 ? "非常に良好" : 
                                        stats.avg_rating >= 3.5 ? "良好" :
                                        stats.avg_rating >= 3.0 ? "普通" :
                                        stats.avg_rating >= 2.5 ? "やや不良" : "不良";
            
            const lengthInterpretation = stats.avg_review_length >= 100 ? "詳細なレビュー" :
                                        stats.avg_review_length >= 50 ? "標準的なレビュー" : "簡潔なレビュー";
            
            document.getElementById('basicStats').innerHTML = `
                <div class="row mb-3">
                    <div class="col-md-2">
                        <div class="stat-card">
                            <div class="stat-value">${stats.total_reviews}</div>
                            <div class="stat-label">総口コミ数</div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="stat-card">
                            <div class="stat-value">${stats.unique_hospitals}</div>
                            <div class="stat-label">病院数</div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="stat-card">
                            <div class="stat-value">${stats.avg_rating.toFixed(2)}</div>
                            <div class="stat-label">平均星評価</div>
                            <div class="stat-interpretation text-small text-muted">${ratingInterpretation}</div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="stat-card">
                            <div class="stat-value">${stats.avg_review_length.toFixed(0)}</div>
                            <div class="stat-label">平均文字数</div>
                            <div class="stat-interpretation text-small text-muted">${lengthInterpretation}</div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="stat-card">
                            <div class="stat-value">${stats.rating_std.toFixed(2)}</div>
                            <div class="stat-label">星評価標準偏差</div>
                            <div class="stat-interpretation text-small text-muted">データのばらつき</div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="stat-card">
                            <div class="stat-value">${stats.length_std.toFixed(0)}</div>
                            <div class="stat-label">文字数標準偏差</div>
                            <div class="stat-interpretation text-small text-muted">レビュー長の多様性</div>
                        </div>
                    </div>
                </div>
                
                <!-- 詳細統計 -->
                <div class="row mb-3">
                    <div class="col-12">
                        <h6><i class="fas fa-info-circle me-2"></i>データ分布の詳細</h6>
                        <div class="row">
                            <div class="col-md-3">
                                <small><strong>星評価範囲:</strong> ${stats.min_rating} - ${stats.max_rating}</small>
                            </div>
                            <div class="col-md-3">
                                <small><strong>中央値:</strong> ${stats.median_rating}</small>
                            </div>
                            <div class="col-md-3">
                                <small><strong>最短レビュー:</strong> ${stats.min_length}文字</small>
                            </div>
                            <div class="col-md-3">
                                <small><strong>最長レビュー:</strong> ${stats.max_length}文字</small>
                            </div>
                        </div>
                    </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function displayMAEComparison(modelComparison) {
            let html = '<div class="alert alert-warning mb-3">';
            html += '<h6><i class="fas fa-calculator me-2"></i>平均絶対誤差 (MAE) 性能評価</h6>';
            
            // MAEの最小値を見つける
            let bestMAE = Math.min(...Object.values(modelComparison).map(m => m.mae));
            let bestModel = Object.keys(modelComparison).find(model => modelComparison[model].mae === bestMAE);
            
            html += `<p class="mb-1"><strong>📈 最高性能モデル:</strong> <span class="text-success">${bestModel}</span> (MAE = ${bestMAE.toFixed(3)})</p>`;
            html += '<p class="small mb-0"><strong>MAEとは:</strong> 予測値と実測値の平均絶対誤差。値が小さいほど予測精度が高い。</p>';
            html += '</div>';
            
            html += '<div class="table-responsive"><table class="table table-striped table-hover">';
            html += '<thead class="table-dark"><tr><th>モデル</th><th>MAE</th><th>相関係数 (r)</th><th>性能ランク</th><th>総合評価</th></tr></thead><tbody>';
            
            // MAEでソートしてランキング
            const sortedModels = Object.entries(modelComparison)
                .sort((a, b) => a[1].mae - b[1].mae)
                .map(([model, data], index) => ({
                    model,
                    mae: data.mae,
                    correlation: data.correlation,
                    rank: index + 1
                }));
            
            sortedModels.forEach((item, index) => {
                const performanceLevel = item.mae <= 0.5 ? "優秀" : 
                                       item.mae <= 1.0 ? "良好" : 
                                       item.mae <= 1.5 ? "普通" : "要改善";
                
                const rankColor = index === 0 ? "text-success" : 
                                 index === 1 ? "text-warning" : "text-danger";
                
                const rankBadge = index === 0 ? '<span class="badge bg-success">1位</span>' :
                                 index === 1 ? '<span class="badge bg-warning">2位</span>' :
                                 '<span class="badge bg-secondary">3位</span>';
                
                html += `<tr>
                    <td><strong>${item.model}</strong></td>
                    <td class="${rankColor}">${item.mae.toFixed(3)}</td>
                    <td>${item.correlation.toFixed(3)}</td>
                    <td>${rankBadge}</td>
                    <td class="${rankColor}">${performanceLevel}</td>
                </tr>`;
            });
            
            html += '</tbody></table></div>';
            document.getElementById('maeComparison').innerHTML = html;
        }
        
        function displayModelComparison(modelComparison) {
            const labels = Object.keys(modelComparison);
            const maeData = labels.map(model => modelComparison[model].mae);
            const correlationData = labels.map(model => modelComparison[model].correlation);
            
            const ctx = document.getElementById('modelChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'MAE (低いほど良い)',
                        data: maeData,
                        backgroundColor: 'rgba(54, 162, 235, 0.8)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        function displayStarDistribution(distribution) {
            const labels = Object.keys(distribution).sort();
            const data = labels.map(star => distribution[star]);
            
            const ctx = document.getElementById('starRatingChart').getContext('2d');
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels.map(star => `${star}星`),
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.8)',
                            'rgba(54, 162, 235, 0.8)',
                            'rgba(255, 205, 86, 0.8)',
                            'rgba(75, 192, 192, 0.8)',
                            'rgba(153, 102, 255, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 12,
                                font: {
                                    size: 14
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((sum, val) => sum + val, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: ${value}件 (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function displayScatterPlots(scatterData, correlations) {
            const models = Object.keys(scatterData);
            
            models.forEach((model, index) => {
                const chartId = `scatterChart${index + 1}`;
                const data = scatterData[model];
                const corr = correlations[model];
                
                // 散布図のトレース
                const scatterTrace = {
                    x: data.star_ratings,
                    y: data.sentiment_scores,
                    mode: 'markers',
                    type: 'scatter',
                    name: 'データポイント',
                    marker: {
                        size: 8,
                        color: ['rgba(255, 99, 132, 0.8)', 'rgba(54, 162, 235, 0.8)', 'rgba(75, 192, 192, 0.8)'][index]
                    }
                };
                
                // 回帰直線の計算
                const n = data.star_ratings.length;
                const sumX = data.star_ratings.reduce((a, b) => a + b, 0);
                const sumY = data.sentiment_scores.reduce((a, b) => a + b, 0);
                const sumXY = data.star_ratings.reduce((sum, x, i) => sum + x * data.sentiment_scores[i], 0);
                const sumX2 = data.star_ratings.reduce((sum, x) => sum + x * x, 0);
                
                const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
                const intercept = (sumY - slope * sumX) / n;
                
                // 回帰直線のポイント（X軸範囲：-2～+2）
                const xRange = [-2, -1, 0, 1, 2];
                const yRegression = xRange.map(x => slope * x + intercept);
                
                // 回帰直線のトレース
                const regressionTrace = {
                    x: xRange,
                    y: yRegression,
                    mode: 'lines',
                    type: 'scatter',
                    name: '回帰直線',
                    line: {
                        color: 'red',
                        width: 2,
                        dash: 'dot'
                    }
                };
                
                const layout = {
                    title: `${model}<br>相関係数 r = ${corr.correlation.toFixed(3)}`,
                    xaxis: { 
                        title: '星評価（正規化後）',
                        range: [-2.2, 2.2],
                        dtick: 1
                    },
                    yaxis: { 
                        title: '感情スコア（正規化後）',
                        range: [-2.2, 2.2]
                    },
                    height: 450,
                    width: 400,
                    showlegend: true,
                    margin: {
                        l: 60,
                        r: 40,
                        t: 80,
                        b: 60
                    },
                    legend: {
                        x: 0.02,
                        y: 0.98,
                        bgcolor: 'rgba(255,255,255,0.8)'
                    }
                };
                
                Plotly.newPlot(chartId, [scatterTrace, regressionTrace], layout);
            });
        }
        
        function displayHospitalAnalysis(hospitalAnalysis) {
            let html = '<div class="alert alert-info mb-3">';
            html += '<h6><i class="fas fa-hospital me-2"></i>病院別感情スコア詳細</h6>';
            html += '<p class="small mb-0">各BERTモデルの感情スコア（正規化済み：-2～+2）と3モデルの平均値を表示しています。</p>';
            html += '</div>';
            
            html += '<div class="table-responsive"><table class="table table-striped table-hover">';
            html += '<thead class="table-dark"><tr>';
            html += '<th>病院ID</th>';
            html += '<th>口コミ数</th>';
            html += '<th>平均星評価<br><small class="text-muted">（正規化後）</small></th>';
            html += '<th>Model A<br><small class="text-muted">(Koheiduck)</small></th>';
            html += '<th>Model B<br><small class="text-muted">(LLM-book)</small></th>';
            html += '<th>Model C<br><small class="text-muted">(Mizuiro)</small></th>';
            html += '<th>平均感情スコア<br><small class="text-muted">（3モデル平均）</small></th>';
            html += '</tr></thead><tbody>';
            
            Object.keys(hospitalAnalysis).forEach(hospitalId => {
                const data = hospitalAnalysis[hospitalId];
                const models = data.model_sentiments || {};
                
                // 各モデルの感情スコアを取得
                const modelA = models['Model A (Koheiduck)'] || 0;
                const modelB = models['Model B (LLM-book)'] || 0;
                const modelC = models['Model C (Mizuiro)'] || 0;
                
                // 色分け用の関数
                const getSentimentColor = (score) => {
                    if (score >= 1.0) return 'text-success';
                    if (score >= 0.5) return 'text-info';
                    if (score >= -0.5) return 'text-secondary';
                    if (score >= -1.0) return 'text-warning';
                    return 'text-danger';
                };
                
                html += `<tr>
                    <td><strong>${hospitalId}</strong></td>
                    <td>${data.review_count}</td>
                    <td class="${data.avg_rating >= 0 ? 'text-success' : 'text-danger'}">${data.avg_rating.toFixed(2)}</td>
                    <td class="${getSentimentColor(modelA)}">${modelA.toFixed(3)}</td>
                    <td class="${getSentimentColor(modelB)}">${modelB.toFixed(3)}</td>
                    <td class="${getSentimentColor(modelC)}">${modelC.toFixed(3)}</td>
                    <td class="${getSentimentColor(data.avg_sentiment)}"><strong>${data.avg_sentiment.toFixed(3)}</strong></td>
                </tr>`;
            });
            
            html += '</tbody></table></div>';
            
            // 感情スコア解釈ガイド
            html += '<div class="row mt-3">';
            html += '<div class="col-12">';
            html += '<div class="alert alert-light">';
            html += '<h6><i class="fas fa-info-circle me-2"></i>感情スコア解釈ガイド</h6>';
            html += '<div class="row small">';
            html += '<div class="col-md-6">';
            html += '<ul class="mb-0">';
            html += '<li><span class="text-success">+1.0以上</span>: 非常にポジティブ</li>';
            html += '<li><span class="text-info">+0.5〜+1.0</span>: ポジティブ</li>';
            html += '<li><span class="text-secondary">-0.5〜+0.5</span>: ニュートラル</li>';
            html += '</ul>';
            html += '</div>';
            html += '<div class="col-md-6">';
            html += '<ul class="mb-0">';
            html += '<li><span class="text-warning">-1.0〜-0.5</span>: ネガティブ</li>';
            html += '<li><span class="text-danger">-1.0未満</span>: 非常にネガティブ</li>';
            html += '</ul>';
            html += '</div>';
            html += '</div>';
            html += '</div>';
            html += '</div>';
            html += '</div>';
            
            document.getElementById('hospitalAnalysis').innerHTML = html;
        }
        
        function displayCorrelationResults(correlations) {
            let html = '<div class="alert alert-info mb-3">';
            html += '<h6><i class="fas fa-chart-line me-2"></i>相関分析結果の解釈</h6>';
            
            // 相関係数の統計計算
            const correlationValues = Object.values(correlations).map(data => data.correlation);
            const bestCorrelation = Math.max(...correlationValues);
            const worstCorrelation = Math.min(...correlationValues);
            const avgCorrelation = correlationValues.reduce((sum, val) => sum + val, 0) / correlationValues.length;
            
            const bestModel = Object.keys(correlations).find(model => correlations[model].correlation === bestCorrelation);
            const worstModel = Object.keys(correlations).find(model => correlations[model].correlation === worstCorrelation);
            
            html += `<p class="mb-1"><strong>📊 分析結果サマリー:</strong></p>`;
            html += `<ul class="mb-1">`;
            html += `<li>最高相関モデル: <strong>${bestModel}</strong> (r=${bestCorrelation.toFixed(3)})</li>`;
            html += `<li>最低相関モデル: <strong>${worstModel}</strong> (r=${worstCorrelation.toFixed(3)})</li>`;
            
            const correlationLevel = avgCorrelation >= 0.7 ? "強い相関" : avgCorrelation >= 0.5 ? "中程度の相関" : avgCorrelation >= 0.3 ? "弱い相関" : "相関なし";
            html += `<li>全体的な相関の強さ: <strong>${correlationLevel}</strong> (平均r=${avgCorrelation.toFixed(3)})</li></ul>`;
            html += '</div>';
            
            html += '<div class="table-responsive"><table class="table table-striped">';
            html += '<thead><tr><th>モデル</th><th>相関係数</th><th>相関の強さ</th><th>95%信頼区間</th><th>統計的有意性</th><th>解釈</th></tr></thead><tbody>';
            
            Object.keys(correlations).forEach(model => {
                const data = correlations[model];
                const r = data.correlation;
                
                // 相関の強さを判定
                const strength = r >= 0.7 ? "強い正の相関" : 
                               r >= 0.5 ? "中程度の正の相関" :
                               r >= 0.3 ? "弱い正の相関" :
                               r >= -0.3 ? "相関なし" :
                               r >= -0.5 ? "弱い負の相関" :
                               r >= -0.7 ? "中程度の負の相関" : "強い負の相関";
                
                // 実用性を判定
                const interpretation = r >= 0.6 ? "実用性高：星評価を良く予測" :
                                     r >= 0.4 ? "実用性中：ある程度予測可能" :
                                     r >= 0.2 ? "実用性低：予測精度は限定的" : "実用性なし：予測に不適";
                
                const strengthColor = r >= 0.6 ? "text-success" : r >= 0.4 ? "text-warning" : "text-danger";
                
                html += `<tr>
                    <td><strong>${model}</strong></td>
                    <td class="${strengthColor}"><strong>${r.toFixed(3)}</strong></td>
                    <td class="${strengthColor}">${strength}</td>
                    <td>[${data.ci_lower.toFixed(3)}, ${data.ci_upper.toFixed(3)}]</td>
                    <td>${data.significant ? '<span class="badge bg-success">有意</span>' : '<span class="badge bg-secondary">非有意</span>'} (p=${data.p_value.toFixed(3)})</td>
                    <td class="small">${interpretation}</td>
                </tr>`;
            });
            
            html += '</tbody></table></div>';
            document.getElementById('correlationResults').innerHTML = html;
        }
        
        function exportResults() {
            if (!analysisResults) {
                showError('エクスポートする結果がありません');
                return;
            }
            
            showProgress('CSVファイルを生成中...');
            
            fetch('/export_results', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({results: analysisResults})
            })
            .then(response => {
                if (response.ok) {
                    return response.blob();
                }
                throw new Error('エクスポートに失敗しました');
            })
            .then(blob => {
                hideProgress();
                
                // ダウンロード
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `動物病院口コミ分析結果_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                showSuccess('CSVファイルのダウンロードが完了しました');
            })
            .catch(error => {
                hideProgress();
                showError('エクスポートエラー: ' + error.message);
            });
        }
        
        function showDataStats(stats) {
            document.getElementById('totalReviews').textContent = stats.total_reviews;
            document.getElementById('uniqueHospitals').textContent = stats.unique_hospitals;
            document.getElementById('avgStarRating').textContent = stats.avg_star_rating.toFixed(2);
            document.getElementById('dataStats').classList.remove('d-none');
        }
        
        function showUploadSuccess(fileName) {
            const uploadArea = document.getElementById('uploadArea');
            uploadArea.innerHTML = `
                <div class="alert alert-success border-0 mb-0">
                    <div class="text-center">
                        <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                        <h5 class="mb-2"><strong>データ読み込み完了</strong></h5>
                        <p class="mb-2">${fileName}</p>
                        <button class="btn btn-outline-primary btn-sm" onclick="resetUpload()">
                            <i class="fas fa-undo me-1"></i>別のファイルを選択
                        </button>
                    </div>
                </div>
            `;
        }
        
        function resetUpload() {
            location.reload();
        }
        
        function showProgress(message) {
            document.getElementById('analysisProgress').classList.remove('d-none');
            document.getElementById('progressText').textContent = message;
        }
        
        function hideProgress() {
            document.getElementById('analysisProgress').classList.add('d-none');
        }
        
        function showError(message) {
            alert('エラー: ' + message);
        }
        
        function showSuccess(message) {
            alert('成功: ' + message);
        }
    </script>
</body>
</html>