<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‹•ç‰©ç—…é™¢å£ã‚³ãƒŸåˆ†æã‚·ã‚¹ãƒ†ãƒ  - ãƒ‡ãƒãƒƒã‚°ç‰ˆ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h1 class="mb-4">ğŸ¥ å‹•ç‰©ç—…é™¢å£ã‚³ãƒŸåˆ†æã‚·ã‚¹ãƒ†ãƒ  - ãƒ‡ãƒãƒƒã‚°ç‰ˆ</h1>
        
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ãƒ†ã‚¹ãƒˆ</h5>
                <button id="loadSampleBtn" class="btn btn-primary">ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿</button>
                <button id="analyzeBtn" class="btn btn-success ms-2" disabled>åˆ†æé–‹å§‹</button>
                
                <div id="status" class="mt-3"></div>
                <div id="results" class="mt-3"></div>
            </div>
        </div>
    </div>

    <script>
        console.log('Debug script loaded');
        
        let uploadedData = null;
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded');
            
            const loadBtn = document.getElementById('loadSampleBtn');
            const analyzeBtn = document.getElementById('analyzeBtn');
            const status = document.getElementById('status');
            const results = document.getElementById('results');
            
            if (loadBtn) {
                loadBtn.addEventListener('click', function() {
                    console.log('Load sample clicked');
                    status.innerHTML = '<div class="alert alert-info">ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>';
                    
                    fetch('/load_sample_data')
                        .then(response => {
                            console.log('Response:', response.status);
                            return response.json();
                        })
                        .then(data => {
                            console.log('Data:', data);
                            if (data.success) {
                                uploadedData = data.data;
                                status.innerHTML = `<div class="alert alert-success">âœ… ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº† (${uploadedData.length}ä»¶)</div>`;
                                analyzeBtn.disabled = false;
                                
                                results.innerHTML = `
                                    <h6>ãƒ‡ãƒ¼ã‚¿æ¦‚è¦:</h6>
                                    <ul>
                                        <li>ç·å£ã‚³ãƒŸæ•°: ${uploadedData.length}</li>
                                        <li>ç—…é™¢æ•°: ${new Set(uploadedData.map(d => d.hospital_id)).size}</li>
                                        <li>å¹³å‡æ˜Ÿè©•ä¾¡: ${(uploadedData.reduce((sum, d) => sum + d.star_rating, 0) / uploadedData.length).toFixed(2)}</li>
                                    </ul>
                                `;
                            } else {
                                status.innerHTML = `<div class="alert alert-danger">âŒ ã‚¨ãƒ©ãƒ¼: ${data.error}</div>`;
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            status.innerHTML = `<div class="alert alert-danger">âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
                        });
                });
            }
            
            if (analyzeBtn) {
                analyzeBtn.addEventListener('click', function() {
                    console.log('Analyze clicked');
                    status.innerHTML = '<div class="alert alert-warning">æ„Ÿæƒ…åˆ†æã‚’å®Ÿè¡Œä¸­...</div>';
                    
                    fetch('/analyze', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({data: uploadedData})
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log('Analysis result:', data);
                        if (data.success) {
                            status.innerHTML = '<div class="alert alert-success">âœ… åˆ†æå®Œäº†</div>';
                            
                            const modelComparison = data.results.model_comparison;
                            const sentimentCorr = data.results.sentiment_correlation.correlations;
                            
                            results.innerHTML += `
                                <h6>åˆ†æçµæœ:</h6>
                                <h7>ãƒ¢ãƒ‡ãƒ«æ€§èƒ½æ¯”è¼ƒ (MAE - ä½ã„ã»ã©è‰¯ã„):</h7>
                                <ul>
                                    <li>Model A (Koheiduck): MAE ${modelComparison['Model A (Koheiduck)'] ? modelComparison['Model A (Koheiduck)'].mae.toFixed(3) : 'N/A'}</li>
                                    <li>Model B (LLM-book): MAE ${modelComparison['Model B (LLM-book)'] ? modelComparison['Model B (LLM-book)'].mae.toFixed(3) : 'N/A'}</li>
                                    <li>Model C (Mizuiro): MAE ${modelComparison['Model C (Mizuiro)'] ? modelComparison['Model C (Mizuiro)'].mae.toFixed(3) : 'N/A'}</li>
                                </ul>
                                <h7>ç›¸é–¢ä¿‚æ•° (é«˜ã„ã»ã©è‰¯ã„):</h7>
                                <ul>
                                    <li>Model A (Koheiduck): r = ${sentimentCorr['Model A (Koheiduck)'] ? sentimentCorr['Model A (Koheiduck)'].correlation.toFixed(3) : 'N/A'}</li>
                                    <li>Model B (LLM-book): r = ${sentimentCorr['Model B (LLM-book)'] ? sentimentCorr['Model B (LLM-book)'].correlation.toFixed(3) : 'N/A'}</li>
                                    <li>Model C (Mizuiro): r = ${sentimentCorr['Model C (Mizuiro)'] ? sentimentCorr['Model C (Mizuiro)'].correlation.toFixed(3) : 'N/A'}</li>
                                </ul>
                            `;
                        } else {
                            status.innerHTML = `<div class="alert alert-danger">âŒ åˆ†æã‚¨ãƒ©ãƒ¼: ${data.error}</div>`;
                        }
                    })
                    .catch(error => {
                        console.error('Analysis error:', error);
                        status.innerHTML = `<div class="alert alert-danger">âŒ åˆ†æã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
                    });
                });
            }
        });
    </script>
</body>
</html>