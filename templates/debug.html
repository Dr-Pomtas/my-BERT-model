<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>動物病院口コミ分析システム - デバッグ版</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h1 class="mb-4">🏥 動物病院口コミ分析システム - デバッグ版</h1>
        
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">サンプルデータテスト</h5>
                <button id="loadSampleBtn" class="btn btn-primary">サンプルデータ読み込み</button>
                <button id="analyzeBtn" class="btn btn-success ms-2" disabled>分析開始</button>
                
                <div id="status" class="mt-3"></div>
                <div id="results" class="mt-3"></div>
            </div>
        </div>
    </div>

    <script>
        console.log('Debug script loaded');
        
        let uploadedData = null;
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded');
            
            const loadBtn = document.getElementById('loadSampleBtn');
            const analyzeBtn = document.getElementById('analyzeBtn');
            const status = document.getElementById('status');
            const results = document.getElementById('results');
            
            if (loadBtn) {
                loadBtn.addEventListener('click', function() {
                    console.log('Load sample clicked');
                    status.innerHTML = '<div class="alert alert-info">サンプルデータを読み込み中...</div>';
                    
                    fetch('/load_sample_data')
                        .then(response => {
                            console.log('Response:', response.status);
                            return response.json();
                        })
                        .then(data => {
                            console.log('Data:', data);
                            if (data.success) {
                                uploadedData = data.data;
                                status.innerHTML = `<div class="alert alert-success">✅ サンプルデータ読み込み完了 (${uploadedData.length}件)</div>`;
                                analyzeBtn.disabled = false;
                                
                                results.innerHTML = `
                                    <h6>データ概要:</h6>
                                    <ul>
                                        <li>総口コミ数: ${uploadedData.length}</li>
                                        <li>病院数: ${new Set(uploadedData.map(d => d.hospital_id)).size}</li>
                                        <li>平均星評価: ${(uploadedData.reduce((sum, d) => sum + d.star_rating, 0) / uploadedData.length).toFixed(2)}</li>
                                    </ul>
                                `;
                            } else {
                                status.innerHTML = `<div class="alert alert-danger">❌ エラー: ${data.error}</div>`;
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            status.innerHTML = `<div class="alert alert-danger">❌ 通信エラー: ${error.message}</div>`;
                        });
                });
            }
            
            if (analyzeBtn) {
                analyzeBtn.addEventListener('click', function() {
                    console.log('Analyze clicked');
                    status.innerHTML = '<div class="alert alert-warning">感情分析を実行中...</div>';
                    
                    fetch('/analyze', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({data: uploadedData})
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log('Analysis result:', data);
                        if (data.success) {
                            status.innerHTML = '<div class="alert alert-success">✅ 分析完了</div>';
                            
                            const modelComparison = data.results.model_comparison;
                            const sentimentCorr = data.results.sentiment_correlation.correlations;
                            
                            results.innerHTML += `
                                <h6>分析結果:</h6>
                                <h7>モデル性能比較 (MAE - 低いほど良い):</h7>
                                <ul>
                                    <li>Model A (Koheiduck): MAE ${modelComparison['Model A (Koheiduck)'] ? modelComparison['Model A (Koheiduck)'].mae.toFixed(3) : 'N/A'}</li>
                                    <li>Model B (LLM-book): MAE ${modelComparison['Model B (LLM-book)'] ? modelComparison['Model B (LLM-book)'].mae.toFixed(3) : 'N/A'}</li>
                                    <li>Model C (Mizuiro): MAE ${modelComparison['Model C (Mizuiro)'] ? modelComparison['Model C (Mizuiro)'].mae.toFixed(3) : 'N/A'}</li>
                                </ul>
                                <h7>相関係数 (高いほど良い):</h7>
                                <ul>
                                    <li>Model A (Koheiduck): r = ${sentimentCorr['Model A (Koheiduck)'] ? sentimentCorr['Model A (Koheiduck)'].correlation.toFixed(3) : 'N/A'}</li>
                                    <li>Model B (LLM-book): r = ${sentimentCorr['Model B (LLM-book)'] ? sentimentCorr['Model B (LLM-book)'].correlation.toFixed(3) : 'N/A'}</li>
                                    <li>Model C (Mizuiro): r = ${sentimentCorr['Model C (Mizuiro)'] ? sentimentCorr['Model C (Mizuiro)'].correlation.toFixed(3) : 'N/A'}</li>
                                </ul>
                            `;
                        } else {
                            status.innerHTML = `<div class="alert alert-danger">❌ 分析エラー: ${data.error}</div>`;
                        }
                    })
                    .catch(error => {
                        console.error('Analysis error:', error);
                        status.innerHTML = `<div class="alert alert-danger">❌ 分析エラー: ${error.message}</div>`;
                    });
                });
            }
        });
    </script>
</body>
</html>